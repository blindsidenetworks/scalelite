# Setting up a call gateway to use dial-in numbers with Scalelite

Scalelite provides some features to allow directing incoming SIP calls received by an external FreeSWITCH server to join BigBlueButton meetings, by dynamically generating FreeSWITCH dialplans that direct callers into the appropriate meeting based on the voice bridge number.

In order to support this, Scalelite maintains an index of voice bridge numbers for each BigBlueButton meeting, and enforces that the voice bridge number allocated to each meeting is unique across all meetings on all BigBlueButton servers.

## Configuring Scalelite

Scalelite has some configuration options, set via environment variables, relating to allocation of voice bridge numbers and authentication for the FreeSWITCH dialplan API. The defaults are usually servicable, but you may wish to change some of them.

(These are also documented in the primary [README](README.md).)

* `VOICE_BRIDGE_LEN`: The length (number of digits) of voice bridge numbers generated by Scalelite. Defaults to `7`. Shorter voice bridge numbers are easier to enter, but also easier to guess through random tries. Your BigBlueButton config must support the selected length.
* `USE_EXTERNAL_VOICE_BRIDGE`: Whether or not to try to use the `voiceBridge` number passed by the BigBlueButton API client. Defaults to `false`. If your API client generates numbers compatible with your BigBlueButton configuration, you can change this to `true` to use them. Note that Scalelite will ignore the voice bridge number provided, and generate a new one, if the number is already in use by a different meeting.
* `FSAPI_PASSWORD`: Password (for "Basic" authentication) to access the freeswitch dialplan API. Default is to use the first `LOADBALANCER_SECRET` as the password. You can set this to the empty string to disable authentication.
* `FSAPI_MAX_DURATION`: Maximum duration for voice calls handled by the freeswitch dialplan integration in minutes. Defaults to `MAX_MEETING_DURATION` if that is set, otherwise no limit. You probably want to set a limit here to ensure you do not have excess expenses due to people not hanging up calls.

## Configuring the Call Gateway server

The call gateway server is a machine that runs FreeSWITCH and is configured to receive calls from an external SIP trunking provider or other mechanism. Selecting a SIP trunking provider and configuring FreeSWITCH to register with it, and locking down FreeSWITCH to avoid attacks are out of scope of this guide. The BigBlueButton [Add a phone number to the conference bridge](https://docs.bigbluebutton.org/admin/customize.html#add-a-phone-number-to-the-conference-bridge) guide has some hints on how to set up the "external" profile for this. You should also read the [FreeSWITCH Security guide](https://freeswitch.org/confluence/display/FREESWITCH/Security).

For support from the FreeSWITCH community, installing from the [upstream Debian packaging](https://freeswitch.org/confluence/display/FREESWITCH/Debian) on a supported Debian version (currently Debian 11) is recommended.

In order to configure FreeSWITCH to bridge calls into the BigBlueButton meetings, the module `xml_curl` is used to have FreeSWITCH request a dynamically generated dialplan XML from Scalelite. In a typical installation, this is configured in the file `/etc/freeswitch/autoload_configs/xml_curl.conf.xml`. An example follows, with the spots that require modification marked.

```xml
<configuration name="xml_curl.conf" description="cURL XML Gateway">
    <bindings>
        <binding name="dialplan">
            <!-- Update the domain name in the gateway-url to the domain name of your Scalelite server -->
            <param name="gateway-url" value="https://scalelite.example.com/fsapi" bindings="dialplan"/>
            <!--
                Update the password in the credentials based on your Scalelite configuration.
                The username is always "fsapi". The default password is the same as the first
                LOADBALANCER_SECRET configured in Scalelite. You can use a different password by
                configuring FSAPI_PASSWORD.
                If FSAPI_PASSWORD is set to the empty string, then authentication is disabled and
                you should comment out both of the following lines.
             -->
            <param name="gateway-credentials" value="fsapi:LOADBALANCER_SECRET"/>
            <param name="auth-scheme" value="basic"/>
        </binding>
    </bindings>
</configuration>
```

After making changes to this configuration, you must restart FreeSWITCH. This configuration is not updated by the `reloadxml` command in a running FreeSWITCH.

## Configuring the BigBlueButton servers

The BigBlueButton server requires changes to allow calls received from the gateway to join the BigBlueButton voice conferences.

Create a dialplan in the "public" context (`/opt/freeswitch/etc/freeswitch/dialplan/public/scalelite.xml`) with the following content:

```xml
<include>
    <extension name="scalelite" continue="true">
        <condition>
            <action application="set" data="bbb_authorized=true"/>
            <action application="transfer" data="${destination_number} XML default"/>
        </condition>
    </extension>
</include>
```

This dialplan sets a variable used internally by BigBlueButton to identify authorized connections, and then directs the call to the "default" dialplan, where it will be joined into the conference.

With this configuration active, it is very important that you firewall port `5060` on your BigBlueButton server correctly. It should accept incoming connections (TCP and UDP) only from the IP address of your Call Gateway server.

With UFW configured with "default deny", this can be done using a command similar to the following:

```sh
ufw allow from 192.0.2.1 to any port 5060
```

You should restart BigBlueButton (`sudo bbb-conf --restart`) after making these changes.
